def retryCount = 3
def retryOccured = false

pipeline {
    agent any
    tools {nodejs "node"}
    parameters {
        gitParameter branchFilter: 'origin/(.*)', defaultValue: 'master', name: 'BRANCH', type: 'PT_BRANCH'
    }
    stages {     
        stage('CleanUp') {
            steps {
                script {
                   sh "git clean -x"
                }
            }
        }     
        stage('Build') {
            steps {
                // Checkout source code from version control (e.g., Git)
                git branch: "${params.BRANCH}", url: 'https://github.com/DaniHNS/automated-testing.git'
                // npm check
                sh 'npm -v'
                // Install project dependencies
                sh 'npm install'
                // Set X11 server - common error fix
                sh 'Xvfb -screen 0 1920x1080x24 :99 & export DISPLAY=:99'
                
            }
        }  
        stage('Run Tests') {
            steps {
                // Run Cypress tests
                sh 'npx cypress run --spec "cypress/e2e/v5/**/*.cy.js" --headless'
            }
        }
          
    }
    post {
        failure {
            script {
                timeout(time: 120, unit: 'SECONDS') {
                    retry(1) {
                      //  sh 'npx cypress run --spec "cypress/e2e/v5/**/*.cy.js" --headless'
                        retryOccured = true
                    }               
                }
            }
        }
        always {
            script {
                if (currentBuild.currentResult == 'FAILURE' && retryOccured == true) {
                    mail to: "plotkin@hotelnetsolutions.de",
                    subject: "Jenkins Build ${currentBuild.currentResult}: Job ${env.JOB_NAME}",
                    body: """${currentBuild.currentResult}: Job ${env.JOB_NAME}
                        More Info can be found here: ${env.BUILD_URL}
                        Video can be found here: http://jenkins.hns.hotelnetsolutions.de/workspace/BookingE2E-V6/cypress/videos/
                        Trigger the Job: http://jenkins.hns.hotelnetsolutions.de:8081/job/BookingE2E-V6/build?token=Gthr1_8"""
                }
            }
        }
    }

}
